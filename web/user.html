<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventBooker - Демо</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }

        .auth-container, .app-container {
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
        }

        .app-container {
            display: none;
        }

        h1 {
            margin-top: 0;
        }

        .auth-tabs {
            margin-bottom: 20px;
        }

        .auth-tab {
            padding: 10px 20px;
            border: 1px solid #ddd;
            background: #424242;
            cursor: pointer;
        }

        .auth-tab.active {
            background: #0a0a0a;
            color: rgb(238, 238, 238);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 10px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
        }

        button {
            padding: 10px 20px;
            border: 1px solid #ddd;
            background: #333;
            color: white;
            cursor: pointer;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .error {
            background: #fdd;
            border: 1px solid #faa;
            padding: 10px;
            margin-bottom: 10px;
            display: none;
        }

        .tab-buttons {
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: 1px solid #ddd;
            background: #646262;
            cursor: pointer;
        }

        .tab-btn.active {
            background: #333;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .event-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
        }

        .event-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .event-info {
            margin-bottom: 10px;
            color: #666;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            background: #ddd;
            margin-right: 5px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .pagination {
            margin-top: 20px;
            text-align: center;
        }

        .pagination button {
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <!-- Авторизация -->
    <div id="authContainer" class="auth-container">
        <h1>EventBooker</h1>
        
        <div id="authError" class="error"></div>

        <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchAuthTab('login')">Вход</button>
            <button class="auth-tab" onclick="switchAuthTab('register')">Регистрация</button>
        </div>

        <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" required>
            </div>
            <div class="form-group">
                <label>Пароль</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit">Войти</button>
        </form>

        <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="registerEmail" required>
            </div>
            <div class="form-group">
                <label>Пароль</label>
                <input type="password" id="registerPassword" required minlength="6">
            </div>
            <div class="form-group">
                <label>Telegram Chat ID (необязательно)</label>
                <input type="number" id="registerTgChatId">
                <a href="https://t.me/Notifierwb_bot">Узнать свой id</a>
            </div>
            <button type="submit">Зарегистрироваться</button>
        </form>
    </div>

    <!-- Приложение -->
    <div id="appContainer" class="app-container">
        <h1>EventBooker</h1>
        <button onclick="logout()">Выйти</button>

        <div id="errorMessage" class="error"></div>

        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('events')">События</button>
            <button class="tab-btn" onclick="switchTab('bookings')">Мои бронирования</button>
        </div>

        <div id="eventsTab" class="tab-content active">
            <div id="eventsLoading" class="loading" style="display: none;">Загрузка...</div>
            <div id="eventsList"></div>
            <div class="pagination">
                <button id="eventsPrevBtn" onclick="loadPreviousEventsPage()" disabled>Назад</button>
                <span id="eventsPageInfo">Страница 0 из 0</span>
                <button id="eventsNextBtn" onclick="loadNextEventsPage()" disabled>Вперёд</button>
            </div>
        </div>

        <div id="bookingsTab" class="tab-content">
            <div id="bookingsLoading" class="loading" style="display: none;">Загрузка...</div>
            <div id="bookingsList"></div>
            <div class="pagination">
                <button id="bookingsPrevBtn" onclick="loadPreviousBookingsPage()" disabled>Назад</button>
                <span id="bookingsPageInfo">Страница 0 из 0</span>
                <button id="bookingsNextBtn" onclick="loadNextBookingsPage()" disabled>Вперёд</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://80.249.151.171/api';
        const PAGE_SIZE = 4;

        let currentEvents = [];
        let eventsPage = 0;
        let eventsTotalPages = 0;
        let eventsTotalCount = 0;

        let currentBookings = [];
        let bookingsPage = 0;
        let bookingsTotalPages = 0;
        let bookingsTotalCount = 0;

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
            document.getElementById('authError').style.display = 'none';
        }

        async function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const tgChatId = document.getElementById('registerTgChatId').value;

            try {
                const body = { email, password };
                if (tgChatId) body.tg_chatid = parseInt(tgChatId);

                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    showApp();
                } else {
                    showAuthError(data.error || 'Ошибка регистрации');
                }
            } catch (error) {
                showAuthError('Ошибка соединения');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    showApp();
                } else {
                    showAuthError(data.error || 'Неверный email или пароль');
                }
            } catch (error) {
                showAuthError('Ошибка соединения');
            }
        }

        function showApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            loadInitialEventsPage();
        }

        function showAuth() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('appContainer').style.display = 'none';
        }

        async function apiRequest(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            
            const config = {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            };

            const response = await fetch(`${API_URL}${endpoint}`, config);

            if (response.status === 401) {
                localStorage.removeItem('token');
                showAuth();
                return null;
            }

            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Ошибка');
            return data;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'events') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('eventsTab').classList.add('active');
                if (currentEvents.length === 0) {
                    loadInitialEventsPage();
                }
            } else {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('bookingsTab').classList.add('active');
                if (currentBookings.length === 0) {
                    loadInitialBookingsPage();
                }
            }
        }

        
        async function loadInitialEventsPage() {
            showEventsLoading(true);
            
            try {
                const futureDate = new Date("0001-01-01T00:00:00Z").toISOString();
                const response = await apiRequest(`/events?last_created_at=${futureDate}&last_id=-1&mode=next&page_size=${PAGE_SIZE}`);
                
                if (!response) return;
                
                currentEvents = response.events || [];
                eventsTotalCount = response.count || 0;
                eventsPage = 1;
                eventsTotalPages = Math.ceil(eventsTotalCount / PAGE_SIZE);
                
                displayEvents(currentEvents);
                updateEventsButtons();
            } catch (error) {
                console.error('Ошибка:', error);
                document.getElementById('eventsList').innerHTML = 
                    '<p style="color: red;">Ошибка загрузки событий</p>';
            } finally {
                showEventsLoading(false);
            }
        }

        async function loadNextEventsPage() {
            if (currentEvents.length === 0 || eventsPage >= eventsTotalPages) return;
            
            showEventsLoading(true);
            
            try {
                const lastEvent = currentEvents[currentEvents.length - 1];
                const lastCreatedAt = new Date(lastEvent.created_at).toISOString();
                const lastID = lastEvent.id;
                
                const response = await apiRequest(
                    `/events?last_created_at=${lastCreatedAt}&last_id=${lastID}&mode=next&page_size=${PAGE_SIZE}`
                );
                
                if (!response) return;
                
                const events = response.events || [];
                eventsTotalCount = response.count || 0;
                
                if (events.length === 0) {
                    alert('Это последняя страница');
                    return;
                }
                
                currentEvents = events;
                eventsPage++;
                eventsTotalPages = Math.ceil(eventsTotalCount / PAGE_SIZE);
                
                displayEvents(events);
                updateEventsButtons();
            } catch (error) {
                console.error('Ошибка:', error);
            } finally {
                showEventsLoading(false);
            }
        }

        async function loadPreviousEventsPage() {
            if (currentEvents.length === 0 || eventsPage === 1) return;
            
            showEventsLoading(true);
            
            try {
                const firstEvent = currentEvents[0];
                const firstCreatedAt = new Date(firstEvent.created_at).toISOString();
                const firstID = firstEvent.id;
                
                const response = await apiRequest(
                    `/events?last_created_at=${firstCreatedAt}&last_id=${firstID}&mode=prev&page_size=${PAGE_SIZE}`
                );
                
                if (!response) return;
                
                const events = response.events || [];
                eventsTotalCount = response.count || 0;
                
                if (events.length === 0) {
                    alert('Это первая страница');
                    return;
                }
                
                currentEvents = events.reverse();
                eventsPage--;
                eventsTotalPages = Math.ceil(eventsTotalCount / PAGE_SIZE);
                
                displayEvents(currentEvents);
                updateEventsButtons();
            } catch (error) {
                console.error('Ошибка:', error);
            } finally {
                showEventsLoading(false);
            }
        }

        function displayEvents(events) {
            if (!events || events.length === 0) {
                document.getElementById('eventsList').innerHTML = 
                    '<div class="empty-state">Нет событий</div>';
                return;
            }

            document.getElementById('eventsList').innerHTML = events.map(event => `
                <div class="event-card">
                    <div class="event-title">${event.title}</div>
                    <div class="event-info">
                        Дата: ${new Date(event.event_date).toLocaleString('ru-RU')}<br>
                        Мест: ${event.total_place - (event.occupied_place || 0)} / ${event.total_place}<br>
                        Статус: <span class="badge">${getStatusText(event.event_status)}</span> <br>

                        ${event.description || ''} 
                    </div>
                    <button onclick="bookEvent(${event.id})" ${event.occupied_place >= event.total_place ? 'disabled' : ''}>
                        Забронировать
                    </button>
                </div>
            `).join('');
        }

        function updateEventsButtons() {
            document.getElementById('eventsPrevBtn').disabled = eventsPage === 1;
            document.getElementById('eventsNextBtn').disabled = eventsPage >= eventsTotalPages;
            document.getElementById('eventsPageInfo').textContent = 
                `Страница ${eventsPage} из ${eventsTotalPages}`;
        }

        function showEventsLoading(show) {
            document.getElementById('eventsLoading').style.display = show ? 'block' : 'none';
        }

        
        async function loadInitialBookingsPage() {
            showBookingsLoading(true);
            
            try {
                const futureDate = new Date("0001-01-01T00:00:00Z").toISOString();
                const response = await apiRequest(`/api/books?last_created_at=${futureDate}&last_id=-1&mode=next&page_size=${PAGE_SIZE}`);
                
                if (!response) return;
                
                currentBookings = response.booking || [];
                bookingsTotalCount = response.count || 0;
                bookingsPage = 1;
                bookingsTotalPages = Math.ceil(bookingsTotalCount / PAGE_SIZE);
                
                displayBookings(currentBookings);
                updateBookingsButtons();
            } catch (error) {
                console.error('Ошибка:', error);
                document.getElementById('bookingsList').innerHTML = 
                    '<p style="color: red;">Ошибка загрузки бронирований</p>';
            } finally {
                showBookingsLoading(false);
            }
        }

        async function loadNextBookingsPage() {
            if (currentBookings.length === 0 || bookingsPage >= bookingsTotalPages) return;
            
            showBookingsLoading(true);
            
            try {
                const lastBooking = currentBookings[currentBookings.length - 1];
                const lastCreatedAt = new Date(lastBooking.created_at).toISOString();
                const lastID = lastBooking.booking_id || lastBooking.id;
                
                const response = await apiRequest(
                    `/api/books?last_created_at=${lastCreatedAt}&last_id=${lastID}&mode=next&page_size=${PAGE_SIZE}`
                );
                
                if (!response) return;
                
                const bookings = response.booking || [];
                bookingsTotalCount = response.count || 0;
                
                if (bookings.length === 0) {
                    alert('Это последняя страница');
                    return;
                }
                
                currentBookings = bookings;
                bookingsPage++;
                bookingsTotalPages = Math.ceil(bookingsTotalCount / PAGE_SIZE);
                
                displayBookings(bookings);
                updateBookingsButtons();
            } catch (error) {
                console.error('Ошибка:', error);
            } finally {
                showBookingsLoading(false);
            }
        }

        async function loadPreviousBookingsPage() {
            if (currentBookings.length === 0 || bookingsPage === 1) return;
            
            showBookingsLoading(true);
            
            try {
                const firstBooking = currentBookings[0];
                const firstCreatedAt = new Date(firstBooking.created_at).toISOString();
                const firstID = firstBooking.booking_id || firstBooking.id;
                
                const response = await apiRequest(
                    `/api/books?last_created_at=${firstCreatedAt}&last_id=${firstID}&mode=prev&page_size=${PAGE_SIZE}`
                );
                
                if (!response) return;
                
                const bookings = response.booking || [];
                bookingsTotalCount = response.count || 0;
                
                if (bookings.length === 0) {
                    alert('Это первая страница');
                    return;
                }
                
                currentBookings = bookings.reverse();
                bookingsPage--;
                bookingsTotalPages = Math.ceil(bookingsTotalCount / PAGE_SIZE);
                
                displayBookings(currentBookings);
                updateBookingsButtons();
            } catch (error) {
                console.error('Ошибка:', error);
            } finally {
                showBookingsLoading(false);
            }
        }

        function displayBookings(bookings) {
            if (!bookings || bookings.length === 0) {
                document.getElementById('bookingsList').innerHTML = 
                    '<div class="empty-state">Нет бронирований</div>';
                return;
            }

            document.getElementById('bookingsList').innerHTML = bookings.map(booking => `
                <div class="event-card">
                    <div class="event-title">
                        Бронирование #${booking.booking_id || booking.id}
                        ${booking.event_title ? ` - ${booking.event_title}` : ''}
                    </div>
                    
                    ${booking.event_description ? `
                        <div class="event-info" style="margin-bottom: 10px;">
                            ${booking.event_description}
                        </div>
                    ` : ''}
                    
                    <div class="event-info">
                        ${booking.event_date ? `
                            Дата события: ${new Date(booking.event_date).toLocaleString()}<br>
                        ` : ''}
                       
                        Создано: ${new Date(booking.created_at).toLocaleString()}<br>
                        ${booking.status === 'pending' ? `
                            Истекает: ${new Date(booking.expires_at).toLocaleString()}<br>
                        ` : ''}
                        Статус: <span class="badge">${getStatusText(booking.status)}</span>
                    </div>
                    ${booking.status === 'pending' ? `
                        <button onclick="confirmBooking(${booking.event_id})">Подтвердить бронь</button>
                    ` : ''}
                    ${booking.status !== 'cancelled'? `
                        <button onclick="canceledBooking(${booking.event_id})">Отменить бронь</button>
                    ` : ''}
                </div>
            `).join('');

            
        }

        function getStatusText(status) {
                const statuses = {
                    'pending': 'Ожидание',
                    'confirmed': 'Подтверждено',
                    'expired': 'Истекло',
                    'cancelled': 'Отменено'
                };
                return statuses[status] || status;
            }

        function updateBookingsButtons() {
            document.getElementById('bookingsPrevBtn').disabled = bookingsPage === 1;
            document.getElementById('bookingsNextBtn').disabled = bookingsPage >= bookingsTotalPages;
            document.getElementById('bookingsPageInfo').textContent = 
                `Страница ${bookingsPage} из ${bookingsTotalPages}`;
        }

        function showBookingsLoading(show) {
            document.getElementById('bookingsLoading').style.display = show ? 'block' : 'none';
        }


        async function bookEvent(eventId) {
            try {
                await apiRequest(`/api/events/${eventId}/book`, { method: 'POST' });
                alert('Бронирование создано!');
                loadInitialEventsPage();
                currentBookings = [];
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        async function confirmBooking(eventId) {
            try {
                await apiRequest(`/api/events/${eventId}/confirm`, { method: 'POST' });

                loadInitialBookingsPage();
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        async function canceledBooking(eventId) {
            try {
                await apiRequest(`/api/events/${eventId}/cancel`, { method: 'POST' });
                loadInitialBookingsPage();
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            showAuth();
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        if (localStorage.getItem('token')) {
            showApp();
        } else {
            showAuth();
        }
    </script>
</body>
</html>
